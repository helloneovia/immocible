// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  acquereur
  agence
  admin
}

enum BienType {
  appartement
  maison
  studio
  loft
  villa
  terrain
  autre
}

enum BienStatus {
  disponible
  reserve
  vendu
  archive
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  role      UserRole
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  profile   Profile?
  biens      Bien[]      @relation("BienOwner")
  recherches Recherche[] @relation("RechercheOwner")
  matches    Match[]      @relation("MatchUser")
  favorites  Favorite[]
  sessions   Session[]
  payments   Payment[]

  // Chat Relations
  agencyConversations Conversation[] @relation("AgencyConversations")
  buyerConversations  Conversation[] @relation("BuyerConversations")
  sentMessages        Message[]      @relation("SentMessages")
  
  // Unlock Relations
  unlockedProfiles UnlockedProfile[] @relation("AgencyUnlocks")
  unlockedBy       UnlockedProfile[] @relation("BuyerUnlocked")

  @@map("users")
}

enum SubscriptionStatus {
  PENDING
  ACTIVE
  INACTIVE
  CANCELLED
}

model Profile {
  id          String   @id @default(uuid())
  userId      String   @unique
  nom         String?
  prenom      String?
  telephone   String?
  nomAgence   String?  // For agence role
  plan        String?  // For agence subscription plan
  subscriptionStatus SubscriptionStatus @default(INACTIVE)
  stripeCustomerId String?
  subscriptionEndDate DateTime?
  adresse     String?
  ville       String?
  codePostal  String?
  
  // Chat Usage
  chatUsageCount Int       @default(0)   // For current billing cycle
  lastUsageReset DateTime  @default(now()) // When the counter was last reset

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("profiles")
}

model Bien {
  id            String     @id @default(uuid())
  ownerId       String
  titre         String
  description   String?    @db.Text
  typeBien      BienType
  prix          Float
  surface       Float      // in mÂ²
  nombrePieces  Int?
  nombreChambres Int?
  adresse       String
  ville         String
  codePostal    String
  quartier      String?
  latitude      Float?
  longitude     Float?
  status        BienStatus @default(disponible)
  images        String[]   // Array of image URLs
  caracteristiques Json?    // Additional characteristics as JSON
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  // Relations
  owner         User      @relation("BienOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  matches        Match[]
  favorites      Favorite[]

  @@map("biens")
  @@index([ownerId])
  @@index([ville, codePostal])
  @@index([typeBien])
  @@index([status])
}

model Recherche {
  id            String   @id @default(uuid())
  ownerId       String
  prixMin       Float?
  prixMax       Float
  surfaceMin    Float?
  surfaceMax    Float?
  typeBien      BienType[]
  localisation  String[] // Array of zones (cities, neighborhoods)
  nombrePieces  String[]
  financement   String?
  caracteristiques Json?  // Additional search criteria as JSON
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  owner         User     @relation("RechercheOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  matches       Match[]

  @@map("recherches")
  @@index([ownerId])
  @@index([isActive])
}

model Match {
  id            String   @id @default(uuid())
  userId        String   // acquereur
  bienId        String
  rechercheId   String?
  score         Float    // Match score 0-100
  raisons       String[] // Reasons for the match
  suggestions   String[] // Suggestions for improvement
  isViewed      Boolean  @default(false)
  isInterested  Boolean?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  user          User     @relation("MatchUser", fields: [userId], references: [id], onDelete: Cascade)
  bien          Bien     @relation(fields: [bienId], references: [id], onDelete: Cascade)
  recherche     Recherche? @relation(fields: [rechercheId], references: [id], onDelete: SetNull)

  @@unique([userId, bienId])
  @@map("matches")
  @@index([userId])
  @@index([bienId])
  @@index([score])
}

model Favorite {
  id        String   @id @default(uuid())
  userId    String
  bienId    String
  createdAt DateTime @default(now())

  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  bien      Bien     @relation(fields: [bienId], references: [id], onDelete: Cascade)

  @@unique([userId, bienId])
  @@map("favorites")
  @@index([userId])
}

model Session {
  id        String   @id @default(uuid())
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())

  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
  @@index([userId])
  @@index([expiresAt])
}

model Payment {
  id              String   @id @default(uuid())
  userId          String
  stripeSessionId String?  @unique
  stripePaymentIntentId String? @unique
  amount          Float
  currency        String   @default("eur")
  status          String   // succeeded, pending, failed, refunded
  plan            String?  // monthly, yearly
  createdAt       DateTime @default(now())

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("payments")
  @@index([userId])
}

model Conversation {
  id          String    @id @default(uuid())
  agencyId    String    // The agency who started it
  buyerId     String    // The buyer
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  // Relations
  agency      User      @relation("AgencyConversations", fields: [agencyId], references: [id], onDelete: Cascade)
  buyer       User      @relation("BuyerConversations", fields: [buyerId], references: [id], onDelete: Cascade)
  messages    Message[]

  @@unique([agencyId, buyerId]) // One conversation per pair
  @@map("conversations")
  @@index([agencyId])
  @@index([buyerId])
}

model Message {
  id              String       @id @default(uuid())
  conversationId  String
  senderId        String
  content         String       @db.Text
  isRead          Boolean      @default(false)
  createdAt       DateTime     @default(now())
  
  // Relations
  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender          User         @relation("SentMessages", fields: [senderId], references: [id])

  @@map("messages")
  @@index([conversationId])
  @@index([senderId])
}

model UnlockedProfile {
  id        String   @id @default(uuid())
  agencyId  String
  buyerId   String
  amount    Float    // Amount paid
  createdAt DateTime @default(now())
  
  agency    User     @relation("AgencyUnlocks", fields: [agencyId], references: [id])
  buyer     User     @relation("BuyerUnlocked", fields: [buyerId], references: [id])

  @@unique([agencyId, buyerId])
  @@map("unlocked_profiles")
}
